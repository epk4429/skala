<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>03. Fetch API와 async/await</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #00ACC1;
            padding-bottom: 10px;
        }
        .example {
            background: #f9f9f9;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #00ACC1;
            border-radius: 5px;
        }
        .output {
            background: #e0f7fa;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            min-height: 50px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #00ACC1;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0097A7;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00ACC1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .user-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: white;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>03. Fetch API와 async/await</h1>
        
        <div class="example">
            <h3>1. Fetch API 기본 - GET 요청</h3>
            <p>Fetch API는 네트워크 요청을 위한 현대적인 JavaScript API입니다.</p>
            <button onclick="showFetchBasic()">Fetch 기본 예제</button>
            <div id="fetch-basic-output" class="output"></div>
        </div>

        <div class="example">
            <h3>2. POST 요청 - 데이터 전송</h3>
            <p>서버에 데이터를 전송하는 POST 요청 방법을 알아봅니다.</p>
            <button onclick="showFetchPost()">POST 요청 예제</button>
            <div id="fetch-post-output" class="output"></div>
        </div>

        <div class="example">
            <h3>3. JSON 데이터 처리</h3>
            <p>JSON 형식의 데이터를 주고받는 방법을 알아봅니다.</p>
            <button onclick="showFetchJSON()">JSON 처리 예제</button>
            <div id="fetch-json-output" class="output"></div>
        </div>

        <div class="example">
            <h3>4. 에러 처리</h3>
            <p>네트워크 요청 중 발생할 수 있는 에러를 처리하는 방법입니다.</p>
            <button onclick="showFetchError()">에러 처리 예제</button>
            <div id="fetch-error-output" class="output"></div>
        </div>

        <div class="example">
            <h3>5. async/await 문법</h3>
            <p>Promise를 더 쉽게 사용할 수 있게 해주는 문법입니다.</p>
            <button onclick="showAsyncAwait()">async/await 예제</button>
            <div id="async-await-output" class="output"></div>
        </div>

        <div class="example">
            <h3>6. 여러 요청 동시 처리</h3>
            <p>여러 API를 동시에 호출하고 결과를 처리합니다.</p>
            <button onclick="showMultipleRequests()">여러 요청 예제</button>
            <div id="multiple-output" class="output"></div>
        </div>

        <div class="example">
            <h3>7. 실전 예제: 사용자 목록 가져오기</h3>
            <p>실제 API를 호출하여 사용자 목록을 가져오는 예제입니다.</p>
            <button onclick="fetchUsers()" id="fetch-users-btn">사용자 목록 가져오기</button>
            <div id="users-output" class="output"></div>
        </div>

        <div class="example">
            <h3>8. 실전 예제: 폼 데이터 전송</h3>
            <p>폼 데이터를 서버로 전송하는 완전한 예제입니다.</p>
            <input type="text" id="user-name" placeholder="이름">
            <input type="email" id="user-email" placeholder="이메일">
            <button onclick="submitForm()" id="submit-btn">전송</button>
            <div id="form-output" class="output"></div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. Fetch API 기본 - GET 요청
        // ============================================
        
        function showFetchBasic() {
            const output = document.getElementById('fetch-basic-output');
            output.innerHTML = '<div class="loading"></div> 데이터 가져오는 중...';
            
            // Fetch API 기본 사용법
            // fetch(url, options) - Promise를 반환합니다
            
            // JSONPlaceholder: 테스트용 무료 API 서비스
            const url = 'https://jsonplaceholder.typicode.com/posts/1';
            
            // GET 요청 (기본값이므로 options 생략 가능)
            fetch(url)
                // fetch()는 Promise를 반환하며, 첫 번째 then()에서 Response 객체를 받습니다
                .then((response) => {
                    // Response 객체: HTTP 응답을 나타냅니다
                    // response.ok: 상태 코드가 200-299 범위인지 확인
                    // response.status: HTTP 상태 코드 (200, 404, 500 등)
                    
                    if (!response.ok) {
                        // 응답이 성공적이지 않으면 에러 발생
                        throw new Error(`HTTP 에러! 상태: ${response.status}`);
                    }
                    
                    // response.json(): 응답 본문을 JSON으로 파싱
                    // 다른 메서드: response.text(), response.blob(), response.arrayBuffer()
                    return response.json();
                })
                .then((data) => {
                    // 파싱된 JSON 데이터가 여기로 전달됩니다
                    output.innerHTML = '<strong>Fetch API 기본 사용법:</strong>\n\n';
                    output.innerHTML += 'fetch(url)\n';
                    output.innerHTML += '  .then(response => response.json())\n';
                    output.innerHTML += '  .then(data => console.log(data))\n';
                    output.innerHTML += '  .catch(error => console.error(error));\n\n';
                    output.innerHTML += '<strong>가져온 데이터:</strong>\n';
                    output.innerHTML += `제목: ${data.title}\n`;
                    output.innerHTML += `내용: ${data.body}\n`;
                    output.innerHTML += `사용자 ID: ${data.userId}`;
                })
                .catch((error) => {
                    // 네트워크 에러나 파싱 에러가 발생하면 여기로 옵니다
                    output.innerHTML = `<span class="error">❌ 에러 발생: ${error.message}</span>`;
                });
        }

        // ============================================
        // 2. POST 요청 - 데이터 전송
        // ============================================
        
        function showFetchPost() {
            const output = document.getElementById('fetch-post-output');
            output.innerHTML = '<div class="loading"></div> 데이터 전송 중...';
            
            // POST 요청: 서버에 데이터를 전송합니다
            const url = 'https://jsonplaceholder.typicode.com/posts';
            
            // 전송할 데이터
            const postData = {
                title: '새로운 게시글',
                body: '이것은 테스트 게시글입니다.',
                userId: 1
            };
            
            // Fetch 옵션 설정
            const options = {
                method: 'POST',           // HTTP 메서드
                headers: {                // 요청 헤더
                    'Content-Type': 'application/json',  // JSON 형식임을 명시
                    // 'Authorization': 'Bearer token123'  // 인증 토큰 예제
                },
                body: JSON.stringify(postData)  // 전송할 데이터를 JSON 문자열로 변환
            };
            
            fetch(url, options)
                .then((response) => {
                    // POST 요청의 응답도 동일하게 처리
                    if (!response.ok) {
                        throw new Error(`HTTP 에러! 상태: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    // 서버가 반환한 데이터 (일반적으로 생성된 리소스의 정보)
                    output.innerHTML = '<strong>POST 요청 예제:</strong>\n\n';
                    output.innerHTML += '<strong>전송한 데이터:</strong>\n';
                    output.innerHTML += JSON.stringify(postData, null, 2) + '\n\n';
                    output.innerHTML += '<strong>서버 응답:</strong>\n';
                    output.innerHTML += JSON.stringify(data, null, 2) + '\n\n';
                    output.innerHTML += '<strong>코드 설명:</strong>\n';
                    output.innerHTML += 'const options = {\n';
                    output.innerHTML += '  method: "POST",\n';
                    output.innerHTML += '  headers: { "Content-Type": "application/json" },\n';
                    output.innerHTML += '  body: JSON.stringify(data)\n';
                    output.innerHTML += '};\n';
                    output.innerHTML += 'fetch(url, options)';
                })
                .catch((error) => {
                    output.innerHTML = `<span class="error">❌ 에러 발생: ${error.message}</span>`;
                });
        }

        // ============================================
        // 3. JSON 데이터 처리
        // ============================================
        
        function showFetchJSON() {
            const output = document.getElementById('fetch-json-output');
            output.innerHTML = '<div class="loading"></div> JSON 데이터 처리 중...';
            
            // JSON (JavaScript Object Notation): 데이터 교환 형식
            // JavaScript 객체와 유사하지만 문자열 형식입니다
            
            const url = 'https://jsonplaceholder.typicode.com/users/1';
            
            fetch(url)
                .then((response) => {
                    // 응답이 JSON 형식인지 확인
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('응답이 JSON 형식이 아닙니다!');
                    }
                    
                    return response.json();
                })
                .then((user) => {
                    output.innerHTML = '<strong>JSON 데이터 처리:</strong>\n\n';
                    output.innerHTML += '<strong>1. JSON 파싱:</strong>\n';
                    output.innerHTML += 'response.json() - 응답 본문을 JavaScript 객체로 변환\n\n';
                    
                    output.innerHTML += '<strong>2. JSON 데이터 사용:</strong>\n';
                    output.innerHTML += `이름: ${user.name}\n`;
                    output.innerHTML += `이메일: ${user.email}\n`;
                    output.innerHTML += `전화번호: ${user.phone}\n`;
                    output.innerHTML += `웹사이트: ${user.website}\n\n`;
                    
                    output.innerHTML += '<strong>3. JSON 문자열로 변환:</strong>\n';
                    output.innerHTML += 'JSON.stringify(user) - 객체를 JSON 문자열로 변환\n';
                    output.innerHTML += JSON.stringify(user, null, 2) + '\n\n';
                    
                    output.innerHTML += '<strong>4. JSON 문자열 파싱:</strong>\n';
                    output.innerHTML += 'JSON.parse(jsonString) - JSON 문자열을 객체로 변환\n';
                    const jsonString = JSON.stringify(user);
                    const parsedUser = JSON.parse(jsonString);
                    output.innerHTML += `파싱 결과: ${parsedUser.name}`;
                })
                .catch((error) => {
                    output.innerHTML = `<span class="error">❌ 에러 발생: ${error.message}</span>`;
                });
        }

        // ============================================
        // 4. 에러 처리
        // ============================================
        
        function showFetchError() {
            const output = document.getElementById('fetch-error-output');
            output.innerHTML = '<div class="loading"></div> 에러 처리 테스트 중...';
            
            // 에러 처리 방법 1: 존재하지 않는 URL
            const invalidUrl = 'https://jsonplaceholder.typicode.com/posts/99999';
            
            fetch(invalidUrl)
                .then((response) => {
                    // 404 에러도 fetch()는 성공적으로 완료됩니다
                    // response.ok로 확인해야 합니다
                    if (!response.ok) {
                        // HTTP 에러 (404, 500 등)
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    output.innerHTML = `데이터: ${JSON.stringify(data)}`;
                })
                .catch((error) => {
                    // 네트워크 에러나 위에서 throw한 에러가 여기로 옵니다
                    output.innerHTML = '<strong>에러 처리 예제:</strong>\n\n';
                    output.innerHTML += `<span class="error">❌ 에러 발생: ${error.message}</span>\n\n`;
                    
                    // 에러 처리 방법 2: 네트워크 에러 시뮬레이션
                    output.innerHTML += '<strong>에러 처리 패턴:</strong>\n';
                    output.innerHTML += '1. response.ok 확인\n';
                    output.innerHTML += '2. try-catch 사용 (async/await와 함께)\n';
                    output.innerHTML += '3. catch()로 에러 처리\n\n';
                    
                    // 올바른 에러 처리 예제
                    const correctUrl = 'https://jsonplaceholder.typicode.com/posts/1';
                    fetch(correctUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            output.innerHTML += '<span class="success">✅ 성공: 데이터 로드 완료</span>\n';
                            output.innerHTML += `제목: ${data.title}`;
                        })
                        .catch(error => {
                            output.innerHTML += `<span class="error">❌ 에러: ${error.message}</span>`;
                        });
                });
        }

        // ============================================
        // 5. async/await 문법
        // ============================================
        
        function showAsyncAwait() {
            const output = document.getElementById('async-await-output');
            output.innerHTML = '<div class="loading"></div> async/await 실행 중...';
            
            // async/await: Promise를 더 쉽게 사용할 수 있게 해주는 문법
            // async 함수 내에서 await를 사용하면 Promise가 완료될 때까지 기다립니다
            
            // async 함수 선언
            async function fetchData() {
                try {
                    // await: Promise가 완료될 때까지 기다림
                    // 동기 코드처럼 보이지만 실제로는 비동기입니다
                    const response = await fetch('https://jsonplaceholder.typicode.com/posts/1');
                    
                    // 응답 확인
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    // JSON 파싱
                    const data = await response.json();
                    
                    return data;
                } catch (error) {
                    // 에러 처리
                    throw error;
                }
            }
            
            // async 함수 호출 (Promise를 반환하므로 then 사용 가능)
            fetchData()
                .then((data) => {
                    output.innerHTML = '<strong>async/await 사용법:</strong>\n\n';
                    output.innerHTML += '<strong>기존 Promise 방식:</strong>\n';
                    output.innerHTML += 'fetch(url)\n';
                    output.innerHTML += '  .then(response => response.json())\n';
                    output.innerHTML += '  .then(data => console.log(data));\n\n';
                    
                    output.innerHTML += '<strong>async/await 방식:</strong>\n';
                    output.innerHTML += 'async function fetchData() {\n';
                    output.innerHTML += '  const response = await fetch(url);\n';
                    output.innerHTML += '  const data = await response.json();\n';
                    output.innerHTML += '  return data;\n';
                    output.innerHTML += '}\n\n';
                    
                    output.innerHTML += '<strong>장점:</strong>\n';
                    output.innerHTML += '- 코드가 더 읽기 쉬움\n';
                    output.innerHTML += '- 동기 코드처럼 작성 가능\n';
                    output.innerHTML += '- try-catch로 에러 처리 가능\n\n';
                    
                    output.innerHTML += '<strong>가져온 데이터:</strong>\n';
                    output.innerHTML += `제목: ${data.title}\n`;
                    output.innerHTML += `내용: ${data.body}`;
                })
                .catch((error) => {
                    output.innerHTML = `<span class="error">❌ 에러: ${error.message}</span>`;
                });
        }

        // ============================================
        // 6. 여러 요청 동시 처리
        // ============================================
        
        function showMultipleRequests() {
            const output = document.getElementById('multiple-output');
            output.innerHTML = '<div class="loading"></div> 여러 요청 처리 중...';
            
            // 여러 API를 동시에 호출하는 방법
            
            // 방법 1: Promise.all() 사용
            async function fetchMultipleData() {
                try {
                    const startTime = Date.now();
                    
                    // 여러 요청을 배열로 만들기
                    const promises = [
                        fetch('https://jsonplaceholder.typicode.com/posts/1').then(r => r.json()),
                        fetch('https://jsonplaceholder.typicode.com/users/1').then(r => r.json()),
                        fetch('https://jsonplaceholder.typicode.com/comments/1').then(r => r.json())
                    ];
                    
                    // Promise.all(): 모든 요청이 완료될 때까지 기다림
                    const [post, user, comment] = await Promise.all(promises);
                    
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    output.innerHTML = '<strong>여러 요청 동시 처리:</strong>\n\n';
                    output.innerHTML += '<strong>방법 1: Promise.all()</strong>\n';
                    output.innerHTML += '모든 요청이 동시에 실행되고 모두 완료될 때까지 기다림\n';
                    output.innerHTML += `소요 시간: ${duration}ms\n\n`;
                    output.innerHTML += `게시글: ${post.title}\n`;
                    output.innerHTML += `사용자: ${user.name}\n`;
                    output.innerHTML += `댓글: ${comment.body}\n\n`;
                    
                    // 방법 2: 순차 처리
                    output.innerHTML += '<strong>방법 2: 순차 처리</strong>\n';
                    const startTime2 = Date.now();
                    
                    const post2 = await fetch('https://jsonplaceholder.typicode.com/posts/2').then(r => r.json());
                    const user2 = await fetch('https://jsonplaceholder.typicode.com/users/2').then(r => r.json());
                    const comment2 = await fetch('https://jsonplaceholder.typicode.com/comments/2').then(r => r.json());
                    
                    const endTime2 = Date.now();
                    const duration2 = endTime2 - startTime2;
                    
                    output.innerHTML += `순차 처리 소요 시간: ${duration2}ms\n`;
                    output.innerHTML += '→ Promise.all()이 더 빠름 (동시 실행)';
                    
                } catch (error) {
                    output.innerHTML = `<span class="error">❌ 에러: ${error.message}</span>`;
                }
            }
            
            fetchMultipleData();
        }

        // ============================================
        // 7. 실전 예제: 사용자 목록 가져오기
        // ============================================
        
        async function fetchUsers() {
            const output = document.getElementById('users-output');
            const button = document.getElementById('fetch-users-btn');
            
            // 버튼 비활성화 (중복 클릭 방지)
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> 로딩 중...';
            output.innerHTML = '';
            
            try {
                // 사용자 목록 가져오기
                const response = await fetch('https://jsonplaceholder.typicode.com/users');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: 사용자 목록을 가져올 수 없습니다.`);
                }
                
                const users = await response.json();
                
                // 사용자 목록 표시
                output.innerHTML = `<span class="success">✅ ${users.length}명의 사용자를 찾았습니다!</span>\n\n`;
                
                users.forEach((user, index) => {
                    output.innerHTML += `<strong>${index + 1}. ${user.name}</strong>\n`;
                    output.innerHTML += `   이메일: ${user.email}\n`;
                    output.innerHTML += `   전화번호: ${user.phone}\n`;
                    output.innerHTML += `   웹사이트: ${user.website}\n\n`;
                });
                
                output.innerHTML += '<strong>코드:</strong>\n';
                output.innerHTML += 'async function fetchUsers() {\n';
                output.innerHTML += '  const response = await fetch(url);\n';
                output.innerHTML += '  const users = await response.json();\n';
                output.innerHTML += '  // 사용자 목록 처리\n';
                output.innerHTML += '}';
                
            } catch (error) {
                output.innerHTML = `<span class="error">❌ 에러 발생: ${error.message}</span>\n\n`;
                output.innerHTML += '에러 처리: 사용자에게 에러 메시지 표시 또는 재시도 옵션 제공';
            } finally {
                // 성공/실패 여부와 관계없이 실행
                button.disabled = false;
                button.innerHTML = '사용자 목록 가져오기';
            }
        }

        // ============================================
        // 8. 실전 예제: 폼 데이터 전송
        // ============================================
        
        async function submitForm() {
            const output = document.getElementById('form-output');
            const button = document.getElementById('submit-btn');
            const nameInput = document.getElementById('user-name');
            const emailInput = document.getElementById('user-email');
            
            // 입력값 가져오기
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            
            // 유효성 검사
            if (!name || !email) {
                output.innerHTML = '<span class="error">❌ 이름과 이메일을 모두 입력해주세요.</span>';
                return;
            }
            
            // 이메일 형식 검사
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(email)) {
                output.innerHTML = '<span class="error">❌ 올바른 이메일 형식을 입력해주세요.</span>';
                return;
            }
            
            // 버튼 비활성화
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> 전송 중...';
            output.innerHTML = '';
            
            try {
                // 폼 데이터 준비
                const formData = {
                    name: name,
                    email: email,
                    createdAt: new Date().toISOString()
                };
                
                // POST 요청 전송
                const response = await fetch('https://jsonplaceholder.typicode.com/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: 전송 실패`);
                }
                
                const result = await response.json();
                
                // 성공 메시지
                output.innerHTML = '<span class="success">✅ 폼이 성공적으로 전송되었습니다!</span>\n\n';
                output.innerHTML += '<strong>전송된 데이터:</strong>\n';
                output.innerHTML += `이름: ${name}\n`;
                output.innerHTML += `이메일: ${email}\n\n`;
                output.innerHTML += '<strong>서버 응답:</strong>\n';
                output.innerHTML += `ID: ${result.id}\n`;
                output.innerHTML += `상태: 성공\n\n`;
                
                // 폼 초기화
                nameInput.value = '';
                emailInput.value = '';
                
            } catch (error) {
                output.innerHTML = `<span class="error">❌ 전송 실패: ${error.message}</span>\n\n`;
                output.innerHTML += '에러 처리: 사용자에게 에러 메시지 표시 및 재시도 옵션 제공';
            } finally {
                // 버튼 다시 활성화
                button.disabled = false;
                button.innerHTML = '전송';
            }
        }
    </script>
</body>
</html>
